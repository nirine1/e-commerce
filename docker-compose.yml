version: "3.9"

services:
    api:
        build:
            context: .
            dockerfile: Dockerfile.api
        container_name: e-commerce-api
        restart: unless-stopped
        volumes:
            - ./api:/var/www/html
            - vendor_data:/var/www/html/vendor
        depends_on:
            - db

    api-nginx:
        image: nginx:alpine
        container_name: e-commerce-api-nginx
        restart: unless-stopped
        ports:
            - "8080:80"
        volumes:
            - ./nginx-api.conf:/etc/nginx/conf.d/default.conf
            - ./api/public:/var/www/html/public
            - ./api/storage/app/public:/var/www/html/storage/app/public
        depends_on:
            - api

    web:
        build:
            context: .
            dockerfile: Dockerfile.web
            target: development # We'll add this target
        container_name: e-commerce-web
        restart: unless-stopped
        ports:
            - "3000:5173" # Vite dev server default port
        volumes:
            - ./web:/app
            - /app/node_modules
        environment:
            - CHOKIDAR_USEPOLLING=true # For file watching on Windows
        command: npm run dev -- --host 0.0.0.0

    db:
        image: mysql:8
        container_name: e-commerce-db
        restart: unless-stopped
        environment:
            MYSQL_DATABASE: e_commerce_db
            MYSQL_USER: e_commerce_db_user
            MYSQL_PASSWORD: hyper_strong_root_pwd_753
            MYSQL_ROOT_PASSWORD: root
        volumes:
            - db_data:/var/lib/mysql

volumes:
    db_data:
    vendor_data:
